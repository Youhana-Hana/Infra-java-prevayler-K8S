# Introduction
We will deploy our application to a Kubernetes cluster created in step 2 [README](../01-deploy-k8s/README.md).
Looking into the reference architecture below, we're going to deploy two Kubernetes deployments and services.
Static files will be served through AWS CloudFront CDN using S3 as origin.

# Setup
## Create AWS CDN And Deploy Static Files to S3

```bash
cd ~/infra-java-prevayler-K8S/02-deploy-app/configure-static-content/ci
./setup -t dev -s ../src
```

For Production:

  ```bash
   cd ~/infra-java-prevayler-K8S/02-deploy-app/configure-static-content/ci
   ./setup -t prod -s ../src
   ```

  This script will fire a terraform plan to create s3 bucket then create CDN    distribution.

Let's have a deeper dive into `02-deploy-app/configure-static-content`:

  ```bash
   cd ~/infra-java-prevayler-K8S/02-deploy-app/configure-static-content/
   ./ls
  ```
* ci. Contains a script to setup S3, CDN and copy static file to created S3
* environments. Contains directory for each environment, in this case, dev and prod. Terraform variables, plan and state will stored per each environment.
* src. Contains terraform main.tf, variables and outputs

To change variables, please check variables file, located under each environment. [dev](02-deploy-app/configure-static-content/environments/dev/dev.tfvars) and [prod](02-deploy-app/configure-static-content/environments/prod/prod.tfvars)

Please note the output CDN name, as it will be used in later step. At anytime you can run `terraform output website_cdn_hostname`


## Build Company News docker images

You can user images published to youhana/, or you can be them from scratch. Please follow below steps to build images:
   ```bash
   cd ~/infra-java-prevayler-K8S/02-deploy-app/k8s/app/docker
   vi static/default.conf
   ```
* Change location pointing to static CDN domain name `http://d2nwqvg6f6qh3u.cloudfront.net` to point to new one generated by above step static.
* Change location pointing to default route `http://af47d4ba3677111e8bc2412cfcff4582-1343252604.us-east-1.elb.amazonaws.com/root/` to the ELB generated by deployment of comaony-news-app, later int these instructions.
* Change docker.io user name in `./build` bash file.

    ```bash
     ./build
    ```

## Deploy Company News to K8S
* Ensure kubectl context is set, by default it should be set to either dev or prod context. You can skip below block if context already set.
   ```bash
    export CLUSTER_ALIAS='dev'
    export CLUSTER_FULL_NAME='dev.youhanalabs.com'
    kubectl config set-context ${CLUSTER_ALIAS} --cluster=${CLUSTER_FULL_NAME}     --user=${CLUSTER_FULL_NAME}
    kubectl config use-context ${CLUSTER_ALIAS}
   ```

* Check cluster status
  ```bash
   kubectl get pod,svc,deploy
   ```

* Deploy Company News

   ```bash
   cd ~/infra-java-prevayler-K8S/02-deploy-app/k8s/app
   ./deploy
   ```
  Once deployment completed and running, run the below command to get the application URL

   ```bash
  kubectl get svc/company-news-static-service --template="{{range       .status.loadBalancer.ingress}} {{.hostname}} {{end}}"
   ```
  Copy above URL, then open the browser and past the URL.

  URL is an AWS ELB DNS name, can be easily added to R53 record for more friendly URL.

## Uninstall Company News Application

   ```bash
   cd ~/infra-java-prevayler-K8S/02-deploy-app/k8s/app
   ./teardown
   ```


